<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Format 3D Converter</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 600px;
        }
        h1 {
            color: #1a237e;
            margin-bottom: 0.5rem;
        }
        p {
            margin-bottom: 2rem;
            color: #555;
        }
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .controls select {
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: #fafafa;
            font-size: 1rem;
        }
        .file-input-container {
            width: 100%;
        }
        input[type="file"] {
            display: none;
        }
        .custom-file-upload {
            border: 2px dashed #999;
            background-color: #fafafa;
            color: #666;
            padding: 1.5rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            font-size: 1rem;
            font-weight: 500;
        }
        .custom-file-upload:hover {
            background-color: #e8eaf6;
            border-color: #1a237e;
            color: #1a237e;
        }
        .download-btn {
            background-color: #4CAF50;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            display: none; /* Initially hidden */
            margin-top: 1rem;
            transition: background-color 0.3s ease;
        }
        .download-btn:hover {
            background-color: #45a049;
        }
        #status {
            margin-top: 1rem;
            font-weight: bold;
            color: #555;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>3D File Converter</h1>
        <p>Convert between STL, 3MF, and OBJ formats. All processing is done locally in your browser.</p>

        <div class="controls">
            <span>Convert to:</span>
            <select id="output-format">
                <option value="stl">STL (.stl)</option>
                <option value="3mf">3MF (.3mf)</option>
                <option value="obj">OBJ (.obj)</option>
            </select>
        </div>

        <div class="file-input-container">
            <label for="file-upload" class="custom-file-upload">
                <span id="upload-text">Drag & Drop or Click to Upload File</span>
            </label>
            <input id="file-upload" type="file" accept=".stl,.3mf,.obj"/>
        </div>

        <div id="status"></div>
        <a id="download-link" class="download-btn" download="converted.stl">Download Converted File</a>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three-3mf-loader@1.0.1/dist/THREE.3MFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/STLExporter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/OBJExporter.js"></script>

    <script>
        // Custom 3MF Exporter (since there isn't a simple one)
        // This is a minimal implementation and may not support all features
        THREE.3MFExporter = function() {};
        THREE.3MFExporter.prototype = {
            constructor: THREE.3MFExporter,
            parse: function(geometry) {
                // Simplified 3MF XML structure
                let xml = '<?xml version="1.0" encoding="utf-8"?>' +
                    '<model unit="millimeter" xml:lang="en-US" xmlns="http://schemas.microsoft.com/3dmanufacturing/core/2015/02">' +
                    '<resources>' +
                    '<object id="1" type="model">' +
                    '<mesh>' +
                    '<vertices>';

                const vertices = geometry.attributes.position.array;
                for (let i = 0; i < vertices.length; i += 3) {
                    xml += `<vertex x="${vertices[i]}" y="${vertices[i + 1]}" z="${vertices[i + 2]}"/>`;
                }
                xml += '</vertices>' +
                    '<triangles>';

                for (let i = 0; i < vertices.length / 3; i += 3) {
                    xml += `<triangle v1="${i}" v2="${i + 1}" v3="${i + 2}"/>`;
                }

                xml += '</triangles>' +
                    '</mesh>' +
                    '</object>' +
                    '</resources>' +
                    '<build><item objectid="1" /></build>' +
                    '</model>';

                // 3MF is a ZIP file, so we need to bundle this XML file
                // For simplicity, we'll just return the XML string
                // A full implementation would require a JS Zip library
                return xml;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('file-upload');
            const statusElement = document.getElementById('status');
            const downloadLink = document.getElementById('download-link');
            const uploadText = document.getElementById('upload-text');
            const outputFormatSelect = document.getElementById('output-format');

            // Set up drag and drop
            const dropArea = document.querySelector('.custom-file-upload');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, e => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.add('active'), false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.remove('active'), false);
            });
            dropArea.addEventListener('drop', handleDrop, false);
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    handleFile({ target: { files: files } });
                }
            }

            fileInput.addEventListener('change', handleFile);

            async function handleFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const inputExt = file.name.split('.').pop().toLowerCase();
                const outputExt = outputFormatSelect.value;
                
                uploadText.textContent = file.name;
                statusElement.textContent = `Converting ${inputExt.toUpperCase()} to ${outputExt.toUpperCase()}...`;
                downloadLink.style.display = 'none';

                if (inputExt === outputExt) {
                    statusElement.textContent = `File is already a .${inputExt}`;
                    return;
                }

                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const buffer = e.target.result;
                        let geometry = null;
                        const threeScene = new THREE.Object3D();
                        
                        // 1. Load the file based on its extension
                        if (inputExt === 'stl') {
                            const loader = new THREE.STLLoader();
                            const meshGeometry = loader.parse(buffer);
                            geometry = meshGeometry;
                            threeScene.add(new THREE.Mesh(geometry));
                        } else if (inputExt === '3mf') {
                            const loader = new THREE.3MFLoader();
                            const object = loader.parse(buffer);
                            geometry = object.children[0].geometry;
                            threeScene.add(object);
                        } else if (inputExt === 'obj') {
                            const loader = new THREE.OBJLoader();
                            const object = loader.parse(buffer);
                            geometry = object.children[0].geometry;
                            threeScene.add(object);
                        } else {
                            statusElement.textContent = `Unsupported input format: .${inputExt}`;
                            return;
                        }

                        // 2. Convert the geometry to the output format
                        let convertedData = null;
                        let mimeType = 'application/octet-stream';
                        if (outputExt === 'stl') {
                            const exporter = new THREE.STLExporter();
                            convertedData = exporter.parse(geometry, { binary: true });
                        } else if (outputExt === '3mf') {
                            const exporter = new THREE.3MFExporter();
                            convertedData = exporter.parse(geometry);
                            mimeType = 'application/vnd.ms-package.3dmanufacturing-3dmodel+xml';
                        } else if (outputExt === 'obj') {
                            const exporter = new THREE.OBJExporter();
                            convertedData = exporter.parse(threeScene);
                            mimeType = 'text/plain';
                        }

                        // 3. Create a downloadable link
                        if (convertedData) {
                            const blob = new Blob([convertedData], { type: mimeType });
                            const url = URL.createObjectURL(blob);
                            downloadLink.href = url;
                            downloadLink.download = `${file.name.split('.')[0]}.${outputExt}`;
                            downloadLink.textContent = `Download .${outputExt.toUpperCase()} File`;
                            downloadLink.style.display = 'block';
                            statusElement.textContent = `Conversion to .${outputExt.toUpperCase()} successful! ✅`;
                        } else {
                            statusElement.textContent = 'Conversion failed.';
                        }

                    } catch (error) {
                        console.error('Conversion failed:', error);
                        statusElement.textContent = `Conversion failed. Details: ${error.message} ❌`;
                    }
                };
                reader.onerror = (error) => {
                    console.error('File read error:', error);
                    statusElement.textContent = 'Error reading the file.';
                };
                reader.readAsArrayBuffer(file);
            }
        });
    </script>
</body>
</html>
